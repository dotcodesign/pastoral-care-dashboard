<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manaaki Hub</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary-color: #667eea;
            --primary-dark: #5a6fd8;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --text-muted: #9ca3af;
            --bg-primary: #f9fafb;
            --bg-secondary: #ffffff;
            --bg-subtle: #f3f4f6;
            --border-color: #e5e7eb;
            --border-light: #f3f4f6;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --border-radius: 12px;
            --transition: all 0.2s ease;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            min-height: 100vh;
            line-height: 1.6;
            color: var(--text-primary);
        }
        
        /* Login Styles */
        .login-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background: var(--primary-color);
            padding: 1rem;
            z-index: 1000;
            min-height: 100vh;
            overflow-y: auto;
        }
        
        .login-card {
            background: var(--bg-secondary);
            border-radius: var(--border-radius);
            padding: 3rem;
            box-shadow: var(--shadow-lg);
            min-width: 420px;
            max-width: 90vw;
            border: 1px solid var(--border-color);
            width: 100%;
            max-width: 500px;
            margin: auto;
        }
        
        .login-title {
            font-size: 2rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 2rem;
            color: var(--text-primary);
        }
        
        .form-group {
            margin-bottom: 1.75rem;
            position: relative;
        }
        
        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 0.75rem;
            letter-spacing: 0.025em;
        }
        
        .form-input {
            width: 100%;
            padding: 1.25rem 1rem;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-size: 0.875rem;
            background: rgba(255, 255, 255, 0.8);
            transition: var(--transition);
            outline: none;
        }
        
        .form-input:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .login-btn {
            width: 100%;
            background: var(--primary-color);
            color: white;
            padding: 1rem;
            border: none;
            border-radius: var(--border-radius);
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .login-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        
        .demo-accounts {
            margin-top: 2rem;
            padding: 1.5rem;
            background: var(--bg-subtle);
            border: 1px solid var(--border-light);
            border-radius: var(--border-radius);
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        /* Header */
        .header {
            background: #ffffff;
            border-bottom: 1px solid #e5e7eb;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1.5rem;
        }
        
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 0;
        }
        
        .header-title {
            font-size: 1.875rem;
            font-weight: 700;
            color: #1f2937;
            margin: 0;
        }
        
        .header-user {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            font-size: 0.875rem;
            color: #6b7280;
            font-weight: 500;
        }
        
        .logout-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        
        .logout-btn:hover {
            background: #dc2626;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }
        
        /* Navigation */
        .nav-tabs {
            display: flex;
            gap: 0;
            overflow-x: auto;
            border-bottom: 1px solid var(--border-color);
        }
        
        .nav-tab {
            padding: 1rem 1.5rem;
            border: none;
            background: none;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            color: var(--text-secondary);
            white-space: nowrap;
            transition: var(--transition);
            position: relative;
        }
        
        .nav-tab::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 3px;
            background: var(--primary-color);
            transition: var(--transition);
        }
        
        .nav-tab:hover {
            color: var(--primary-color);
            background: rgba(102, 126, 234, 0.05);
        }
        
        .nav-tab.active {
            color: var(--primary-color);
            background: rgba(102, 126, 234, 0.1);
        }
        
        .nav-tab.active::before {
            width: 100%;
            background: var(--primary-color);
        }
        
        .nav-tab.hidden {
            display: none;
        }
        
        /* Main Content */
        .main-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2.5rem 1.5rem;
            position: relative;
            z-index: 1;
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Dashboard Header Section */
        .dashboard-header {
            background: var(--primary-color);
            color: white;
            border-radius: var(--border-radius);
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-md);
        }
        
        .dashboard-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        
        .dashboard-total {
            text-align: right;
        }
        
        .dashboard-greeting h2 {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .total-number {
            font-size: 3rem;
            font-weight: 800;
            line-height: 1;
        }
        
        .total-label {
            font-size: 0.875rem;
            opacity: 0.9;
            font-weight: 500;
        }
        
        .stats-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
        }
        
        .stat-box {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            text-align: center;
            transition: var(--transition);
        }
        
        .stat-box:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
        }
        
        .stat-number {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }
        
        .stat-label {
            font-size: 0.75rem;
            opacity: 0.9;
            font-weight: 500;
        }
        
        /* Two Column Layout */
        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2.5rem;
            margin-bottom: 2.5rem;
        }
        
        .column-header {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0 0.5rem;
        }
        
        .urgent-header {
            color: #e53e3e;
        }
        
        .followup-header {
            color: #3182ce;
        }
        
        /* Cards */
        .action-card {
            background: var(--bg-secondary);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            margin-bottom: 1.5rem;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            transition: var(--transition);
            position: relative;
        }
        
        .action-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
        }
        
        .card-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border-color);
            position: relative;
        }
        
        .card-header h4 {
            font-weight: 700;
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }
        
        .card-header p {
            font-size: 0.875rem;
            margin: 0;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .card-header.urgent {
            background: #fef2f2;
            color: #991b1b;
            border-bottom-color: #fecaca;
        }
        
        .card-header.warning {
            background: #fffbeb;
            color: #92400e;
            border-bottom-color: #fde68a;
        }
        
        .card-header.info {
            background: #f0f9ff;
            color: #1e40af;
            border-bottom-color: #bae6fd;
        }
        
        .card-header.success {
            background: #f0fdf4;
            color: #15803d;
            border-bottom-color: #bbf7d0;
        }
        
        .card-content {
            padding: 2.5rem;
            text-align: center;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .card-content.success-message {
            color: #16a34a;
            font-weight: 600;
        }
        
        /* Student List Styles */
        .student-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 1rem;
            margin-bottom: 0.75rem;
            font-size: 0.875rem;
            transition: var(--transition);
            border-left: 4px solid var(--border-color);
        }
        
        .student-item:hover {
            transform: translateX(2px);
            box-shadow: var(--shadow-md);
        }
        
        .student-urgent {
            background: #fef2f2;
            border-color: #fecaca;
            border-left-color: #ef4444;
            color: #991b1b;
        }
        
        .student-warning {
            background: #fffbeb;
            border-color: #fde68a;
            border-left-color: #f59e0b;
            color: #92400e;
        }
        
        .student-success {
            background: #f0fdf4;
            border-color: #bbf7d0;
            border-left-color: #10b981;
            color: #15803d;
        }
        
        /* Buttons */
        .btn {
            border: none;
            padding: 0.5rem 1rem;
            border-radius: calc(var(--border-radius) - 4px);
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        
        .btn-primary {
            background: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
        }
        
        .btn-success {
            background: var(--success-color);
            color: white;
        }
        
        .btn-success:hover {
            background: #059669;
        }
        
        .btn-warning {
            background: var(--warning-color);
            color: white;
        }
        
        .btn-warning:hover {
            background: #d97706;
        }
        
        .btn-danger {
            background: var(--danger-color);
            color: white;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
        }
        
        /* Debug info */
        .debug-info {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            border-radius: var(--border-radius);
            padding: 1rem;
            margin: 1rem 0;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
            font-size: 0.8rem;
            color: #0c4a6e;
        }
        
        /* File Upload Area */
        .upload-area {
            border: 2px dashed var(--border-color);
            border-radius: var(--border-radius);
            padding: 3rem;
            text-align: center;
            cursor: pointer;
            background: var(--bg-secondary);
            transition: var(--transition);
        }
        
        .upload-area:hover {
            border-color: var(--primary-color);
            background: rgba(102, 126, 234, 0.02);
        }
        
        .upload-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }
        
        .upload-subtitle {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            animation: modalFadeIn 0.2s ease-out;
        }
        
        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            background: var(--bg-secondary);
            padding: 2rem;
            border-radius: var(--border-radius);
            max-width: 80%;
            max-height: 80%;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
            animation: modalSlideIn 0.2s ease-out;
        }
        
        @keyframes modalSlideIn {
            from { opacity: 0; transform: translateY(10px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        
        /* Toast Notification */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--success-color);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: var(--border-radius);
            z-index: 3000;
            box-shadow: var(--shadow-lg);
            font-weight: 500;
            animation: toastSlideIn 0.2s ease-out;
        }
        
        @keyframes toastSlideIn {
            from { opacity: 0; transform: translateX(100%); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        /* Utilities */
        .hidden { 
            display: none !important; 
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .two-column { 
                grid-template-columns: 1fr; 
                gap: 1.5rem; 
            }
            .stats-row { 
                grid-template-columns: repeat(2, 1fr); 
            }
            .dashboard-top { 
                flex-direction: column; 
                text-align: center; 
                gap: 1.5rem; 
            }
            .login-card {
                min-width: 300px;
                max-width: 95vw;
                padding: 2rem;
                margin: 1rem;
            }
            .main-content {
                padding: 1.5rem 1rem;
            }
            .header-content {
                padding: 0 1rem;
            }
            .dashboard-header {
                padding: 2rem;
            }
        }
        
        @media (max-width: 480px) {
            .stats-row { 
                grid-template-columns: 1fr; 
            }
            .header-top {
                flex-direction: column;
                gap: 1rem;
            }
            .nav-tabs {
                flex-wrap: wrap;
            }
            .login-card {
                min-width: 280px;
                max-width: 95vw;
                padding: 1.5rem;
                margin: 0.5rem;
            }
            .login-title {
                font-size: 1.5rem;
            }
            .demo-accounts {
                font-size: 0.75rem;
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="login-screen" class="login-container">
        <div class="login-card">
            <h1 class="login-title">🎓 Manaaki Hub</h1>
            <div class="form-group">
                <label for="username" class="form-label">Username</label>
                <input type="text" id="username" class="form-input" placeholder="Enter your username">
            </div>
            <div class="form-group">
                <label for="password" class="form-label">Password</label>
                <input type="password" id="password" class="form-input" placeholder="Enter your password">
            </div>
            <button onclick="login()" class="login-btn">Login</button>
            
            <div id="login-error" class="hidden" style="margin-top: 1rem; padding: 1rem; background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; color: #991b1b; font-size: 0.875rem; text-align: center;">
                ❌ Incorrect username or password. Please try again.
            </div>
            
            <div class="demo-accounts">
                <strong>🔑 Demo Accounts:</strong><br>
                <strong>Data Administrator:</strong> admin / admin123<br>
                <strong>Whānau Leaders:</strong> hinau/hinau123, kowhai/kowhai123, tawa/tawa123, miro/miro123<br>
                <strong>Whānau Teachers:</strong><br>
                <em>Year 9:</em> 9han/9han123, 9kat/9kat123, 9mat/9mat123, 9tmc/9tmc123, 9whi/9whi123, 9kar/9kar123<br>
                <em>Year 10:</em> 10han/10han123, 10kat/10kat123, 10mat/10mat123, 10tmc/10tmc123, 10whi/10whi123, 10kar/10kar123, 10hcv/10hcv123<br>
                <em>Year 11:</em> 11han/11han123, 11kat/11kat123, 11mat/11mat123, 11tmc/11tmc123, 11whi/11whi123, 11kar/11kar123<br>
                <em>Year 12:</em> 12han/12han123, 12kat/12kat123, 12mat/12mat123, 12tmc/12tmc123, 12whi/12whi123, 12kar/12kar123<br>
                <em>Year 13:</em> 13han/13han123, 13kat/13kat123, 13mat/13mat123, 13tmc/13tmc123, 13whi/13whi123, 13kar/13kar123<br>
                <em style="font-size: 0.75rem;">Each whānau teacher sees only their class students</em>
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="main-dashboard" class="hidden">
        <div class="header">
            <div class="header-content">
                <div class="header-top">
                    <h1 class="header-title">Manaaki Hub</h1>
                    <div class="header-user">
                        <span id="current-date"></span>
                        <span id="user-info"></span>
                        <button onclick="logout()" class="logout-btn">Logout</button>
                    </div>
                </div>
                
                <nav class="nav-tabs">
                    <button class="nav-tab active" onclick="switchTab('dashboard')" id="tab-dashboard">My Day</button>
                    <button class="nav-tab" onclick="switchTab('data')" id="tab-data">Data Entry</button>
                    <button class="nav-tab" onclick="switchTab('urgent')" id="tab-urgent">Urgent Action</button>
                    <button class="nav-tab" onclick="switchTab('tutor-analysis')" id="tab-tutor-analysis">Whānau Teacher Follow-up</button>
                    <button class="nav-tab" onclick="switchTab('celebrations')" id="tab-celebrations">Celebrations</button>
                    <button class="nav-tab" onclick="switchTab('students')" id="tab-students">All Students</button>
                </nav>
            </div>
        </div>

        <div class="main-content">
            <!-- My Day Tab -->
            <div id="content-dashboard" class="tab-content active">
                <!-- Dashboard Header -->
                <div class="dashboard-header">
                    <div class="dashboard-top">
                        <div class="dashboard-greeting">
                            <h2 id="dashboard-title">Good morning! Here's your day</h2>
                            <p id="current-date-dashboard"></p>
                        </div>
                        <div class="dashboard-total">
                            <div class="total-number" id="total-actions">0</div>
                            <div class="total-label">actions needed</div>
                        </div>
                    </div>
                    
                    <div class="stats-row" id="stats-row">
                        <div class="stat-box">
                            <div class="stat-number" id="urgent-calls-stat">0</div>
                            <div class="stat-label" id="urgent-calls-label">Urgent Calls</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-number" id="follow-ups-stat">0</div>
                            <div class="stat-label">Follow-ups</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-number" id="celebrations-stat">0</div>
                            <div class="stat-label">Celebrations</div>
                        </div>
                    </div>
                </div>

                <!-- Debug Info -->
                <div id="debug-info" class="debug-info hidden">
                    <strong>🐛 Debug Info:</strong><br>
                    <span id="debug-text">No data loaded yet</span>
                </div>

                <!-- Two Column Layout -->
                <div class="two-column" id="dashboard-cards">
                    <!-- Left Column: Urgent Actions -->
                    <div>
                        <div class="column-header urgent-header">
                            🚨 Urgent Actions (Do First)
                        </div>
                        
                        <!-- Calls Needed Today Card -->
                        <div class="action-card">
                            <div class="card-header urgent">
                                <h4>🚨 Urgent Follow-up</h4>
                                <p>Pastoral and attendance issues requiring immediate action</p>
                            </div>
                            <div id="urgent-calls-content" class="card-content">
                                📁 Upload student data to see urgent follow-up requirements
                            </div>
                        </div>

                        <!-- Escalate to Leadership Card -->
                        <div class="action-card">
                            <div class="card-header warning">
                                <h4>⚠️ Escalate to Leadership</h4>
                                <p>The 2 most concerning cases needing leader support</p>
                            </div>
                            <div id="escalation-content" class="card-content">
                                📁 Upload student data to see escalation requirements
                            </div>
                        </div>
                    </div>

                    <!-- Right Column: Follow-up Actions -->
                    <div>
                        <div class="column-header followup-header">
                            📋 Follow-up Actions
                        </div>
                        
                        <!-- Email/Check-ins Card -->
                        <div class="action-card">
                            <div class="card-header info">
                                <h4>📋 Medium Priority</h4>
                                <p>Pastoral, attendance, class effort and academic concerns</p>
                            </div>
                            <div id="followup-content" class="card-content">
                                📁 Upload student data to see medium priority actions
                            </div>
                        </div>

                        <!-- Celebrate Success Card -->
                        <div class="action-card">
                            <div class="card-header success">
                                <h4>🌟 Celebrations</h4>
                                <p>Students showing excellent progress and achievements</p>
                            </div>
                            <div id="celebration-content" class="card-content">
                                📁 Upload student data to see celebration opportunities
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Data Entry Tab -->
            <div id="content-data" class="tab-content">
                <div class="action-card">
                    <div class="card-header info">
                        <h4>📁 Upload KAMAR Data</h4>
                        <p id="data-upload-description">Upload your KAMAR export CSV file to analyze student data</p>
                    </div>
                    <div class="card-content">
                        <div class="upload-area" onclick="document.getElementById('file-upload').click()">
                            <div class="upload-title">📎 Upload CSV File</div>
                            <div class="upload-subtitle" id="upload-instructions">Click to browse or drag & drop your export file</div>
                            <input id="file-upload" type="file" accept=".csv" onchange="handleFileUpload(event)" style="display: none;">
                            <div id="upload-status" style="margin-top: 1rem; font-size: 0.875rem; font-weight: 600;" class="hidden"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Urgent Action Tab -->
            <div id="content-urgent" class="tab-content">
                <div class="action-card">
                    <div class="card-header urgent">
                        <h4>🚨 Urgent Action Required</h4>
                        <p>High-priority cases needing immediate attention</p>
                    </div>
                    <div id="urgent-tab-content" class="card-content">
                        📁 Upload student data to see urgent action items
                    </div>
                </div>
            </div>

            <!-- Whānau Teacher Analysis Tab -->
            <div id="content-tutor-analysis" class="tab-content">
                <div class="action-card">
                    <div class="card-header warning">
                        <h4>⚠️ Whānau Teacher Follow-up Analysis</h4>
                        <p>Analysis of whānau classes and attendance patterns</p>
                    </div>
                    <div id="tutor-analysis-content" class="card-content">
                        📁 Upload student data to see whānau teacher analysis
                    </div>
                </div>
            </div>

            <!-- Celebrations Tab -->
            <div id="content-celebrations" class="tab-content">
                <div class="two-column">
                    <div>
                        <div class="column-header" style="color: #10b981;">
                            🎯 Attendance Achievements
                        </div>
                        
                        <div class="action-card">
                            <div class="card-header success">
                                <h4>⭐ Overall Attendance Excellence</h4>
                                <p>Students with 95%+ attendance (year-long)</p>
                            </div>
                            <div id="celebrations-attendance-overall-content" class="card-content">
                                📁 Upload student data to see overall attendance stars
                            </div>
                        </div>
                        
                        <div class="action-card">
                            <div class="card-header success">
                                <h4>📈 Attendance Improvements</h4>
                                <p>Students with 10%+ attendance increases (15 days)</p>
                            </div>
                            <div id="celebrations-attendance-increase-content" class="card-content">
                                📁 Upload student data to see attendance improvements
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <div class="column-header" style="color: #10b981;">
                            🎓 Academic & Personal Growth
                        </div>
                        
                        <div class="action-card">
                            <div class="card-header success">
                                <h4>🎓 Newly Passed NCEA</h4>
                                <p>Students who've just achieved 80+ credits</p>
                            </div>
                            <div id="celebrations-ncea-passed-content" class="card-content">
                                📁 Upload student data to see newly passed students
                            </div>
                        </div>
                        
                        <div class="action-card">
                            <div class="card-header success">
                                <h4>💪 Effort Improvements</h4>
                                <p>Students showing significant effort gains</p>
                            </div>
                            <div id="celebrations-effort-improvement-content" class="card-content">
                                📁 Upload student data to see effort improvements
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- All Students Tab -->
            <div id="content-students" class="tab-content">
                <div class="action-card">
                    <div class="card-header info">
                        <h4>👥 All Students Overview</h4>
                        <p>Complete student data and risk analysis</p>
                    </div>
                    <div id="students-tab-content" class="card-content">
                        📁 Upload student data to view all students
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let rawStudentsData = [];
        let filteredStudentsData = [];
        let currentAnalysis = {
            urgentCalls: [],
            escalations: [],
            followUps: [],
            celebrations: []
        };
        let completedActions = {
            urgentCalls: new Map(), // studentId -> { completedDate, cooldownDays }
            escalations: new Map(),
            followUps: new Map(),
            celebrations: new Map(),
            pastoralBaseline: new Map() // studentId -> { pastoralA, pastoralC, pastoralD, pastoralU } at time of completion
        };
        let previousStudentsData = [];

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateDateTime();
            
            const passwordField = document.getElementById('password');
            if (passwordField) {
                passwordField.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        login();
                    }
                });
            }
        });

        // Date/time functions
        function updateDateTime() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            const dateString = now.toLocaleDateString('en-NZ', options);
            
            const currentDateEl = document.getElementById('current-date');
            const currentDateDashboardEl = document.getElementById('current-date-dashboard');
            
            if (currentDateEl) currentDateEl.textContent = dateString;
            if (currentDateDashboardEl) currentDateDashboardEl.textContent = dateString;
        }

        // Data persistence functions
        function saveDataToStorage(data) {
            // Store a deep copy of current data as previous before updating
            if (rawStudentsData.length > 0) {
                previousStudentsData = rawStudentsData.map(student => ({...student}));
            }
            rawStudentsData = data;
            return true;
        }

        function loadDataFromStorage() {
            return rawStudentsData || [];
        }

        function clearDataFromStorage() {
            rawStudentsData = [];
        }

        // Authentication functions
        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const loginError = document.getElementById('login-error');

            // Hide any previous error message
            if (loginError) {
                loginError.classList.add('hidden');
            }

            if (!username || !password) {
                showLoginError('Please enter both username and password');
                return;
            }

            const validUsers = {
                'admin': { password: 'admin123', role: 'Data Administrator', type: 'admin' },
                'hinau': { password: 'hinau123', role: 'Hīnau Whānau Leader', type: 'whanau-leader', house: 'Hīnau' },
                'kowhai': { password: 'kowhai123', role: 'Kowhai Whānau Leader', type: 'whanau-leader', house: 'Kowhai' },
                'tawa': { password: 'tawa123', role: 'Tawa Whānau Leader', type: 'whanau-leader', house: 'Tawa' },
                'miro': { password: 'miro123', role: 'Miro Whānau Leader', type: 'whanau-leader', house: 'Miro' },
                
                // Year 9 Whānau Classes
                '9han': { password: '9han123', role: 'Whānau Teacher - 9HAN', type: 'tutor', tutorClass: '9HAN' },
                '9kat': { password: '9kat123', role: 'Whānau Teacher - 9KAT', type: 'tutor', tutorClass: '9KAT' },
                '9mat': { password: '9mat123', role: 'Whānau Teacher - 9MAT', type: 'tutor', tutorClass: '9MAT' },
                '9tmc': { password: '9tmc123', role: 'Whānau Teacher - 9TMC', type: 'tutor', tutorClass: '9TMC' },
                '9whi': { password: '9whi123', role: 'Whānau Teacher - 9WHI', type: 'tutor', tutorClass: '9WHI' },
                '9kar': { password: '9kar123', role: 'Whānau Teacher - 9KAR', type: 'tutor', tutorClass: '9KAR' },
                
                // Year 10 Whānau Classes
                '10han': { password: '10han123', role: 'Whānau Teacher - 10HAN', type: 'tutor', tutorClass: '10HAN' },
                '10kat': { password: '10kat123', role: 'Whānau Teacher - 10KAT', type: 'tutor', tutorClass: '10KAT' },
                '10mat': { password: '10mat123', role: 'Whānau Teacher - 10MAT', type: 'tutor', tutorClass: '10MAT' },
                '10tmc': { password: '10tmc123', role: 'Whānau Teacher - 10TMC', type: 'tutor', tutorClass: '10TMC' },
                '10whi': { password: '10whi123', role: 'Whānau Teacher - 10WHI', type: 'tutor', tutorClass: '10WHI' },
                '10kar': { password: '10kar123', role: 'Whānau Teacher - 10KAR', type: 'tutor', tutorClass: '10KAR' },
                '10hcv': { password: '10hcv123', role: 'Whānau Teacher - 10HCV', type: 'tutor', tutorClass: '10HCV' },
                
                // Year 11 Whānau Classes
                '11han': { password: '11han123', role: 'Whānau Teacher - 11HAN', type: 'tutor', tutorClass: '11HAN' },
                '11kat': { password: '11kat123', role: 'Whānau Teacher - 11KAT', type: 'tutor', tutorClass: '11KAT' },
                '11mat': { password: '11mat123', role: 'Whānau Teacher - 11MAT', type: 'tutor', tutorClass: '11MAT' },
                '11tmc': { password: '11tmc123', role: 'Whānau Teacher - 11TMC', type: 'tutor', tutorClass: '11TMC' },
                '11whi': { password: '11whi123', role: 'Whānau Teacher - 11WHI', type: 'tutor', tutorClass: '11WHI' },
                '11kar': { password: '11kar123', role: 'Whānau Teacher - 11KAR', type: 'tutor', tutorClass: '11KAR' },
                
                // Year 12 Whānau Classes
                '12han': { password: '12han123', role: 'Whānau Teacher - 12HAN', type: 'tutor', tutorClass: '12HAN' },
                '12kat': { password: '12kat123', role: 'Whānau Teacher - 12KAT', type: 'tutor', tutorClass: '12KAT' },
                '12mat': { password: '12mat123', role: 'Whānau Teacher - 12MAT', type: 'tutor', tutorClass: '12MAT' },
                '12tmc': { password: '12tmc123', role: 'Whānau Teacher - 12TMC', type: 'tutor', tutorClass: '12TMC' },
                '12whi': { password: '12whi123', role: 'Whānau Teacher - 12WHI', type: 'tutor', tutorClass: '12WHI' },
                '12kar': { password: '12kar123', role: 'Whānau Teacher - 12KAR', type: 'tutor', tutorClass: '12KAR' },
                
                // Year 13 Whānau Classes
                '13han': { password: '13han123', role: 'Whānau Teacher - 13HAN', type: 'tutor', tutorClass: '13HAN' },
                '13kat': { password: '13kat123', role: 'Whānau Teacher - 13KAT', type: 'tutor', tutorClass: '13KAT' },
                '13mat': { password: '13mat123', role: 'Whānau Teacher - 13MAT', type: 'tutor', tutorClass: '13MAT' },
                '13tmc': { password: '13tmc123', role: 'Whānau Teacher - 13TMC', type: 'tutor', tutorClass: '13TMC' },
                '13whi': { password: '13whi123', role: 'Whānau Teacher - 13WHI', type: 'tutor', tutorClass: '13WHI' },
                '13kar': { password: '13kar123', role: 'Whānau Teacher - 13KAR', type: 'tutor', tutorClass: '13KAR' }
            };

            if (validUsers[username] && validUsers[username].password === password) {
                currentUser = validUsers[username];

                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('main-dashboard').classList.remove('hidden');
                
                document.getElementById('user-info').textContent = currentUser.role + ': ' + username;
                
                setupUserInterface();
                updateDateTime();
                
                rawStudentsData = loadDataFromStorage();
                
                if (rawStudentsData.length > 0 && currentUser.type !== 'admin') {
                    filterAndAnalyzeData();
                } else if (currentUser.type !== 'admin') {
                    showNoDataMessage(currentUser.type);
                }
                
                if (rawStudentsData.length > 0 && currentUser.type === 'admin') {
                    generateAdminDashboard();
                }
            } else {
                showLoginError('Incorrect username or password. Please try again.');
            }
        }

        function showLoginError(message) {
            const loginError = document.getElementById('login-error');
            if (loginError) {
                loginError.textContent = `❌ ${message}`;
                loginError.classList.remove('hidden');
                
                // Clear the password field for security
                const passwordField = document.getElementById('password');
                if (passwordField) {
                    passwordField.value = '';
                    passwordField.focus();
                }
            }
        }

        function logout() {
            currentUser = null;
            filteredStudentsData = [];
            currentAnalysis = {
                urgentCalls: [],
                escalations: [],
                followUps: [],
                celebrations: []
            };
            completedActions = {
                urgentCalls: new Map(),
                escalations: new Map(),
                followUps: new Map(),
                celebrations: new Map(),
                pastoralBaseline: new Map()
            };
            
            document.getElementById('main-dashboard').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            
            // Hide any login error message
            const loginError = document.getElementById('login-error');
            if (loginError) {
                loginError.classList.add('hidden');
            }
            
            resetAllContent();
        }

        function setupUserInterface() {
            if (currentUser.type === 'admin') {
                const tabsToHide = ['tab-urgent', 'tab-tutor-analysis', 'tab-celebrations', 'tab-students'];
                tabsToHide.forEach(tabId => {
                    const tab = document.getElementById(tabId);
                    if (tab) tab.classList.add('hidden');
                });
                
                const dataTab = document.getElementById('tab-data');
                if (dataTab) dataTab.classList.remove('hidden');
                
                const dashboardTab = document.getElementById('tab-dashboard');
                const dashboardTitle = document.getElementById('dashboard-title');
                
                if (dashboardTab) dashboardTab.textContent = '📊 Data Management';
                if (dashboardTitle) dashboardTitle.textContent = 'Data Upload & Management Center';
                
                const dashboardCards = document.getElementById('dashboard-cards');
                if (dashboardCards) dashboardCards.style.display = 'none';
                
                switchTab('data');
                
            } else if (currentUser.type === 'tutor') {
                const tabsToHide = ['tab-data', 'tab-urgent', 'tab-tutor-analysis', 'tab-celebrations', 'tab-students'];
                tabsToHide.forEach(tabId => {
                    const tab = document.getElementById(tabId);
                    if (tab) tab.classList.add('hidden');
                });
                
                const dashboardTab = document.getElementById('tab-dashboard');
                const dashboardTitle = document.getElementById('dashboard-title');
                
                if (dashboardTab) dashboardTab.textContent = `${currentUser.tutorClass} Dashboard`;
                if (dashboardTitle) dashboardTitle.textContent = `Welcome to your ${currentUser.tutorClass} whānau class!`;
                
                const urgentLabel = document.getElementById('urgent-calls-label');
                if (urgentLabel) urgentLabel.textContent = 'Action Needed';
                
                const statsRow = document.getElementById('stats-row');
                if (statsRow) statsRow.style.gridTemplateColumns = 'repeat(3, 1fr)';
                
                const dashboardCards = document.getElementById('dashboard-cards');
                if (dashboardCards) dashboardCards.style.display = 'grid';
                
                switchTab('dashboard');
                
            } else {
                const tabsToHide = ['tab-data'];
                tabsToHide.forEach(tabId => {
                    const tab = document.getElementById(tabId);
                    if (tab) tab.classList.add('hidden');
                });
                
                const tabsToShow = ['tab-urgent', 'tab-tutor-analysis', 'tab-celebrations', 'tab-students'];
                tabsToShow.forEach(tabId => {
                    const tab = document.getElementById(tabId);
                    if (tab) tab.classList.remove('hidden');
                });
                
                const dashboardTab = document.getElementById('tab-dashboard');
                const dashboardTitle = document.getElementById('dashboard-title');
                
                if (currentUser.type === 'whanau-leader') {
                    if (dashboardTab) dashboardTab.textContent = `${currentUser.house} Dashboard`;
                    if (dashboardTitle) dashboardTitle.textContent = `Kia ora! Welcome to ${currentUser.house} Whānau`;
                }
                
                const statsRow = document.getElementById('stats-row');
                if (statsRow) statsRow.style.gridTemplateColumns = 'repeat(3, 1fr)';
                
                const dashboardCards = document.getElementById('dashboard-cards');
                if (dashboardCards) dashboardCards.style.display = 'grid';
            }
        }

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById('tab-' + tabName).classList.add('active');

            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById('content-' + tabName).classList.add('active');
            
            // If admin switches to dashboard tab, show admin dashboard
            // If non-admin switches to dashboard tab, ensure regular dashboard is shown
            if (tabName === 'dashboard' && currentUser) {
                if (currentUser.type === 'admin' && rawStudentsData.length > 0) {
                    generateAdminDashboard();
                } else if (currentUser.type !== 'admin' && rawStudentsData.length > 0) {
                    // Restore regular dashboard for non-admin users
                    restoreRegularDashboard();
                }
            }
        }
        
        function restoreRegularDashboard() {
            // Restore the original dashboard cards structure for non-admin users
            const dashboardCards = document.getElementById('dashboard-cards');
            if (!dashboardCards) return;
            
            dashboardCards.style.display = 'grid';
            dashboardCards.innerHTML = `
                <!-- Left Column: Urgent Actions -->
                <div>
                    <div class="column-header urgent-header">
                        🚨 Urgent Actions (Do First)
                    </div>
                    
                    <!-- Calls Needed Today Card -->
                    <div class="action-card">
                        <div class="card-header urgent">
                            <h4>🚨 Urgent Follow-up</h4>
                            <p>Pastoral and attendance issues requiring immediate action</p>
                        </div>
                        <div id="urgent-calls-content" class="card-content">
                            📁 Upload student data to see urgent follow-up requirements
                        </div>
                    </div>

                    <!-- Escalate to Leadership Card -->
                    <div class="action-card">
                        <div class="card-header warning">
                            <h4>⚠️ Escalate to Leadership</h4>
                            <p>The 2 most concerning cases needing leader support</p>
                        </div>
                        <div id="escalation-content" class="card-content">
                            📁 Upload student data to see escalation requirements
                        </div>
                    </div>
                </div>

                <!-- Right Column: Follow-up Actions -->
                <div>
                    <div class="column-header followup-header">
                        📋 Follow-up Actions
                    </div>
                    
                    <!-- Email/Check-ins Card -->
                    <div class="action-card">
                        <div class="card-header info">
                            <h4>📋 Medium Priority</h4>
                            <p>Pastoral, attendance, class effort and academic concerns</p>
                        </div>
                        <div id="followup-content" class="card-content">
                            📁 Upload student data to see medium priority actions
                        </div>
                    </div>

                    <!-- Celebrate Success Card -->
                    <div class="action-card">
                        <div class="card-header success">
                            <h4>🌟 Celebrations</h4>
                            <p>Students showing excellent progress and achievements</p>
                        </div>
                        <div id="celebration-content" class="card-content">
                            📁 Upload student data to see celebration opportunities
                        </div>
                    </div>
                </div>
            `;
            
            // Restore regular dashboard stats and content
            updateAllDashboardSections();
        }

        // File upload handling
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file && file.type === 'text/csv') {
                processCSVFile(file);
            } else {
                alert('Please select a valid CSV file');
            }
        }

        function processCSVFile(file) {
            const uploadStatus = document.getElementById('upload-status');
            uploadStatus.innerHTML = '⏳ Processing file...';
            uploadStatus.classList.remove('hidden');

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csv = e.target.result;
                    const lines = csv.split('\n');
                    const students = [];

                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (line) {
                            const columns = parseCSVLine(line);
                            if (columns.length >= 60) {
                                const student = {
                                    id: columns[0] || '',
                                    gender: (columns[1] || '').trim(),
                                    ethnicity: (columns[2] || '').trim(),
                                    yearLevel: parseInt(columns[3]) || 0,
                                    house: (columns[4] || '').trim(),
                                    tutor: (columns[5] || '').trim(),
                                    studentType: (columns[6] || '').trim(),
                                    
                                    inClassYear: parseFloat(columns[7]) || 0,
                                    inClass5Days: parseFloat(columns[8]) || 0,
                                    inClass15Days: parseFloat(columns[9]) || 0,
                                    inClassTrend: (columns[10] || '').trim(),
                                    
                                    hdpYear: parseFloat(columns[11]) || 0,
                                    hdp5Days: parseFloat(columns[12]) || 0,
                                    hdp15Days: parseFloat(columns[13]) || 0,
                                    hdpTrend: (columns[14] || '').trim(),
                                    
                                    hdjYear: parseFloat(columns[15]) || 0,
                                    hdj5Days: parseFloat(columns[16]) || 0,
                                    hdj15Days: parseFloat(columns[17]) || 0,
                                    
                                    hduYear: parseFloat(columns[18]) || 0,
                                    hdu5Days: parseFloat(columns[19]) || 0,
                                    hdu15Days: parseFloat(columns[20]) || 0,
                                    
                                    lCountYear: parseFloat(columns[21]) || 0,
                                    lCount5Days: parseFloat(columns[22]) || 0,
                                    lCount15Days: parseFloat(columns[23]) || 0,
                                    
                                    unknownCountYear: parseFloat(columns[24]) || 0,
                                    unknownCount5Days: parseFloat(columns[25]) || 0,
                                    unknownCount15Days: parseFloat(columns[26]) || 0,
                                    
                                    tCountYear: parseFloat(columns[27]) || 0,
                                    tCount5Days: parseFloat(columns[28]) || 0,
                                    tCount15Days: parseFloat(columns[29]) || 0,
                                    
                                    hdpCountYear: parseFloat(columns[30]) || 0,
                                    hdjCountYear: parseFloat(columns[31]) || 0,
                                    hduCountYear: parseFloat(columns[32]) || 0,
                                    daysLateYear: parseFloat(columns[33]) || 0,
                                    
                                    countAllPastoral: parseFloat(columns[34]) || 0,
                                    pastoralA: parseFloat(columns[35]) || 0,
                                    pastoralC: parseFloat(columns[36]) || 0,
                                    pastoralD: parseFloat(columns[37]) || 0,
                                    pastoralG: parseFloat(columns[38]) || 0,
                                    pastoralO: parseFloat(columns[39]) || 0,
                                    pastoralU: parseFloat(columns[40]) || 0,
                                    
                                    demerits: parseFloat(columns[41]) || 0,
                                    points: parseFloat(columns[42]) || 0,
                                    
                                    classEffortYear: parseFloat(columns[43]) || 0,
                                    classEffort15Days: parseFloat(columns[44]) || 0,
                                    
                                    cyNotAchieved: parseFloat(columns[45]) || 0,
                                    cyAchieved: parseFloat(columns[46]) || 0,
                                    cyMerit: parseFloat(columns[47]) || 0,
                                    cyExcellence: parseFloat(columns[48]) || 0,
                                    cyTotalCredits: parseFloat(columns[49]) || 0,
                                    cyAttempted: parseFloat(columns[50]) || 0,
                                    cyPercentPassed: parseFloat(columns[51]) || 0,
                                    cyGPA: parseFloat(columns[52]) || 0,
                                    cyAvailable: parseFloat(columns[53]) || 0,
                                    
                                    l1Literacy: (columns[54] || '').trim(),
                                    numeracy: (columns[55] || '').trim(),
                                    creditsUsedLitNum: parseInt(columns[56]) || 0,
                                    l2CreditsUsedLitNum: parseInt(columns[57]) || 0,
                                    l3CreditsUsedLitNum: parseInt(columns[58]) || 0,
                                    ueLiteracy: (columns[59] || '').trim(),
                                    
                                    // Academic tracking - Column AX (index 49 is cyTotalCredits, so AX should be around index 49)
                                    // Note: Need to verify the exact column mapping
                                    academicScore: parseFloat(columns[49]) || 0  // This might need adjustment based on actual AX column position
                                };

                                if (student.id) {
                                    students.push(student);
                                }
                            }
                        }
                    }

                    rawStudentsData = students;
                    saveDataToStorage(students);
                    
                    const uploadDate = new Date().toLocaleDateString('en-NZ');
                    uploadStatus.innerHTML = `✅ Successfully processed ${students.length} students - data uploaded ${uploadDate}`;
                    uploadStatus.style.color = '#16a34a';

                    if (currentUser.type === 'admin') {
                        addClearDataButton();
                    }

                    if (currentUser.type !== 'admin') {
                        filterAndAnalyzeData();
                    } else {
                        generateAdminDashboard();
                    }

                } catch (error) {
                    uploadStatus.innerHTML = '❌ Error processing file: ' + error.message;
                    uploadStatus.style.color = '#dc2626';
                }
            };

            reader.readAsText(file);
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            return result;
        }

        function addClearDataButton() {
            const uploadStatus = document.getElementById('upload-status');
            if (uploadStatus && !document.getElementById('clear-data-btn')) {
                const clearButton = document.createElement('button');
                clearButton.id = 'clear-data-btn';
                clearButton.innerHTML = '🗑️ Clear All Data';
                clearButton.className = 'btn btn-danger btn-sm';
                clearButton.style.marginLeft = '1rem';
                clearButton.onclick = function() {
                    if (confirm('Are you sure you want to clear all student data? This will affect all users.')) {
                        clearAllData();
                    }
                };
                uploadStatus.appendChild(clearButton);
            }
        }

        function clearAllData() {
            rawStudentsData = [];
            filteredStudentsData = [];
            currentAnalysis = { urgentCalls: [], escalations: [], followUps: [], celebrations: [] };
            
            clearDataFromStorage();
            
            const uploadStatus = document.getElementById('upload-status');
            if (uploadStatus) {
                uploadStatus.innerHTML = '✅ All data cleared successfully';
                uploadStatus.style.color = '#16a34a';
            }
            
            const clearBtn = document.getElementById('clear-data-btn');
            if (clearBtn) clearBtn.remove();
            
            setTimeout(() => {
                if (uploadStatus) {
                    uploadStatus.innerHTML = '';
                    uploadStatus.classList.add('hidden');
                }
            }, 2000);
        }

        function filterAndAnalyzeData() {
            if (!currentUser || rawStudentsData.length === 0 || currentUser.type === 'admin') {
                return;
            }

            const attendingStudents = rawStudentsData.filter(student => {
                const tutor = (student.tutor || '').trim().toUpperCase();
                const excludedCodes = ['ALTED', 'EXCLUDED', 'NHS', 'SSTS', ''];
                return !excludedCodes.includes(tutor);
            });

            if (currentUser.type === 'tutor') {
                filteredStudentsData = attendingStudents.filter(student => student.tutor === currentUser.tutorClass);
            } else if (currentUser.type === 'whanau-leader') {
                filteredStudentsData = attendingStudents.filter(student => {
                    if (student.tutor === '9TMC') {
                        return currentUser.house === 'Tawa';
                    }
                    
                    // Normalize house names to handle encoding issues
                    const studentHouse = normalizeHouseName(student.house);
                    const userHouse = normalizeHouseName(currentUser.house);
                    
                    return studentHouse === userHouse;
                });
            } else {
                filteredStudentsData = [...attendingStudents];
            }

            analyzeStudentData();
        }
        
        function normalizeHouseName(houseName) {
            if (!houseName) return '';
            
            // Convert to string and normalize
            const normalized = houseName.toString().trim();
            
            // Handle common encoding variations
            const houseMap = {
                'hīnau': 'Hīnau',
                'hinau': 'Hīnau',
                'hÄ«nau': 'Hīnau',
                'h�nau': 'Hīnau',
                
                'kōwhai': 'Kowhai',
                'kowhai': 'Kowhai',
                'kåwhai': 'Kowhai',
                'k�whai': 'Kowhai',
                'koÌwhai': 'Kowhai',
                
                'tawa': 'Tawa',
                'tāwa': 'Tawa',
                'taÌwa': 'Tawa',
                't�wa': 'Tawa',
                
                'miro': 'Miro',
                'mīro': 'Miro',
                'miÌro': 'Miro',
                'm�ro': 'Miro'
            };
            
            // Check exact matches first (case insensitive)
            const lowerNormalized = normalized.toLowerCase();
            if (houseMap[lowerNormalized]) {
                return houseMap[lowerNormalized];
            }
            
            // Fallback to original with proper casing
            const properCase = normalized.charAt(0).toUpperCase() + normalized.slice(1).toLowerCase();
            return properCase;
        }

        function analyzeStudentData() {
            if (filteredStudentsData.length === 0) {
                resetAllContent();
                return;
            }

            currentAnalysis = {
                urgentCalls: [],
                escalations: [],
                followUps: [],
                celebrations: []
            };

            filteredStudentsData.forEach(student => {
                const effortChange = (student.classEffort15Days || 0) - (student.classEffortYear || 0);
                const hdp15Days = student.hdp15Days || 0;
                const tCount15Days = student.tCount15Days || 0;
                const tCount5Days = student.tCount5Days || 0;
                const lCount15Days = student.lCount15Days || 0;
                const lCount5Days = student.lCount5Days || 0;
                const unknownCount15Days = student.unknownCount15Days || 0;
                const unknownCount5Days = student.unknownCount5Days || 0;
                const yearLevel = student.yearLevel || 0;
                const cyTotalCredits = student.cyTotalCredits || 0;
                const countAllPastoral = student.countAllPastoral || 0;
                
                const studentIndex = filteredStudentsData.indexOf(student);
                
                if (currentUser.type === 'tutor') {
                    const previousStudent = previousStudentsData.find(prev => prev.id === student.id);
                    
                    const newPastoralEntries = previousStudent ? 
                        Math.max(0, (countAllPastoral - (previousStudent.countAllPastoral || 0))) : 0;
                    
                    const hasNewPastoral = newPastoralEntries > 0;
                    
                    // Check for specific pastoral category increases (AJ, AK, AL, AO = indices 35, 36, 37, 40)
                    let specificPastoralIncreases = 0;
                    const pastoralCategories = [];
                    let hasNewPastoralSinceBaseline = false;
                    
                    if (previousStudent) {
                        // Get the baseline pastoral counts (either from completion or from previous upload)
                        const baseline = completedActions.pastoralBaseline.get(student.id);
                        const compareAgainst = baseline || previousStudent;
                        
                        // PastoralA (index 35)
                        const pastoralAIncrease = (student.pastoralA || 0) - (compareAgainst.pastoralA || 0);
                        if (pastoralAIncrease > 0) {
                            specificPastoralIncreases += pastoralAIncrease;
                            pastoralCategories.push(`Attendance: +${pastoralAIncrease}`);
                            hasNewPastoralSinceBaseline = true;
                        }
                        
                        // PastoralC (index 36) 
                        const pastoralCIncrease = (student.pastoralC || 0) - (compareAgainst.pastoralC || 0);
                        if (pastoralCIncrease > 0) {
                            specificPastoralIncreases += pastoralCIncrease;
                            pastoralCategories.push(`Classroom: +${pastoralCIncrease}`);
                            hasNewPastoralSinceBaseline = true;
                        }
                        
                        // PastoralD (index 37)
                        const pastoralDIncrease = (student.pastoralD || 0) - (compareAgainst.pastoralD || 0);
                        if (pastoralDIncrease > 0) {
                            specificPastoralIncreases += pastoralDIncrease;
                            pastoralCategories.push(`Discipline: +${pastoralDIncrease}`);
                            hasNewPastoralSinceBaseline = true;
                        }
                        
                        // PastoralU (index 40)
                        const pastoralUIncrease = (student.pastoralU || 0) - (compareAgainst.pastoralU || 0);
                        if (pastoralUIncrease > 0) {
                            specificPastoralIncreases += pastoralUIncrease;
                            pastoralCategories.push(`Uniform: +${pastoralUIncrease}`);
                            hasNewPastoralSinceBaseline = true;
                        }
                    }
                    
                    // Check for academic achievement (CYTotal Credits reaching 60+ for Years 12 & 13)
                    let academicAlert = false;
                    if (previousStudent && (yearLevel === 12 || yearLevel === 13)) {
                        const previousCredits = previousStudent.cyTotalCredits || 0;
                        const currentCredits = student.cyTotalCredits || 0;
                        
                        // Alert if student reaches 60+ credits (passes the year)
                        if (currentCredits >= 60 && previousCredits < 60) {
                            academicAlert = true;
                        }
                    }
                    
                    // Updated urgency check - T and ? codes always show for tutors, pastoral increases only if NEW since baseline
                    const hasUrgentAttendance = unknownCount5Days >= 1 || tCount5Days >= 1 || lCount5Days >= 3;
                    const hasPastoralOrAcademic = hasNewPastoralSinceBaseline || academicAlert;
                    
                    // For tutors: attendance codes always urgent, pastoral/academic only if new since completion
                    const isUrgent = hasUrgentAttendance || hasPastoralOrAcademic;
                    
                    if (isUrgent) {
                        const reasons = [];
                        if (unknownCount5Days >= 1) reasons.push(`${unknownCount5Days} ? codes (5 days)`);
                        if (tCount5Days >= 1) reasons.push(`${tCount5Days} T codes (5 days)`);
                        if (lCount5Days >= 3) reasons.push(`${lCount5Days} lates (5 days)`);
                        if (hasNewPastoralSinceBaseline) reasons.push(`🚨 NEW: ${pastoralCategories.join(', ')} since last action`);
                        if (academicAlert) reasons.push(`🎓 NEWLY PASSED Year ${yearLevel}! Credits: ${(previousStudent?.cyTotalCredits || 0)} → ${cyTotalCredits}`);
                        
                        currentAnalysis.urgentCalls.push({
                            ...student,
                            reason: reasons.join(', '),
                            priority: 1,
                            isAttendanceUrgent: hasUrgentAttendance,
                            isPastoralAcademic: hasPastoralOrAcademic
                        });
                    }
                    
                    if (!isUrgent && (hdp15Days < 85 || effortChange < -0.2 || (yearLevel >= 11 && cyTotalCredits < 40))) {
                        const reasons = [];
                        if (hdp15Days < 85) reasons.push(`Low attendance: ${hdp15Days.toFixed(1)}%`);
                        if (effortChange < -0.2) reasons.push(`Effort declining: ${effortChange.toFixed(1)}`);
                        if (yearLevel >= 11 && cyTotalCredits < 40) reasons.push(`Low credits: ${cyTotalCredits}`);
                        
                        currentAnalysis.followUps.push({
                            ...student,
                            reason: reasons.join(', '),
                            priority: 2
                        });
                    }
                    
                    if (hdp15Days < 60 || tCount15Days >= 8 || specificPastoralIncreases >= 3) {
                        const reasons = [];
                        if (hdp15Days < 60) reasons.push(`Critical attendance: ${hdp15Days.toFixed(1)}%`);
                        if (tCount15Days >= 8) reasons.push(`Severe truancy: ${tCount15Days} incidents`);
                        if (specificPastoralIncreases >= 3) reasons.push(`🚨 Multiple pastoral increases: ${pastoralCategories.join(', ')} since last upload`);
                        
                        currentAnalysis.escalations.push({
                            ...student,
                            reason: reasons.join(', '),
                            severity: hdp15Days < 50 ? 10 : (tCount15Days >= 10 ? 9 : 8)
                        });
                    }
                    
                    const prevStudentData = previousStudentsData.find(prev => prev.id === student.id);
                    
                    if ((student.hdpYear || 0) >= 95) {
                        currentAnalysis.celebrations.push({
                            ...student,
                            reason: `Excellent overall attendance: ${student.hdpYear.toFixed(1)}% (year)`,
                            category: 'attendance-overall'
                        });
                    }
                    
                    if (prevStudentData) {
                        const hdpIncrease = (student.hdp15Days || 0) - (prevStudentData.hdp15Days || 0);
                        if (hdpIncrease >= 10) {
                            currentAnalysis.celebrations.push({
                                ...student,
                                reason: `Attendance improved by ${hdpIncrease.toFixed(1)}% (15 days): ${student.hdp15Days.toFixed(1)}%`,
                                category: 'attendance-increase'
                            });
                        }
                    }
                    
                    // Credit and grade tracking
                    if ((student.yearLevel || 0) >= 11 && prevStudentData) {
                        const previousCredits = prevStudentData.cyTotalCredits || 0;
                        const currentCredits = student.cyTotalCredits || 0;
                        
                        // Track credit changes
                        const creditChange = currentCredits - previousCredits;
                        
                        if (creditChange < -5) {
                            currentAnalysis.followUps.push({
                                ...student,
                                reason: `📉 Credits dropped significantly: ${previousCredits} → ${currentCredits} (${creditChange} since last upload)`,
                                priority: 2
                            });
                        }
                        
                        // Track newly passed students
                        if (currentCredits >= 80 && previousCredits < 80) {
                            currentAnalysis.celebrations.push({
                                ...student,
                                reason: `🎓 Newly passed Year ${student.yearLevel}! Credits increased: ${previousCredits} → ${currentCredits} since last upload`,
                                category: 'ncea-passed'
                            });
                        }
                        
                        // Track grade quality changes (Excellence → Achieved, etc.)
                        const prevExcellence = prevStudentData.cyExcellence || 0;
                        const currExcellence = student.cyExcellence || 0;
                        const prevMerit = prevStudentData.cyMerit || 0;
                        const currMerit = student.cyMerit || 0;
                        const prevAchieved = prevStudentData.cyAchieved || 0;
                        const currAchieved = student.cyAchieved || 0;
                        
                        // Check for grade quality decline
                        if (prevExcellence > currExcellence && (currAchieved > prevAchieved || currMerit > prevMerit)) {
                            const excellenceDropped = prevExcellence - currExcellence;
                            currentAnalysis.followUps.push({
                                ...student,
                                reason: `📊 Grade quality decline: Lost ${excellenceDropped} Excellence credits (${prevExcellence} → ${currExcellence}) since last upload`,
                                priority: 2
                            });
                        }
                    }
                    
                    // Add academic celebration for newly passing the year
                    if (academicAlert) {
                        currentAnalysis.celebrations.push({
                            ...student,
                            reason: `🎓 NEWLY PASSED Year ${yearLevel}! Credits increased: ${(previousStudent?.cyTotalCredits || 0)} → ${cyTotalCredits} (60+ required)`,
                            category: 'year-passed'
                        });
                    }
                    
                    if (effortChange >= 0.3) {
                        currentAnalysis.celebrations.push({
                            ...student,
                            reason: `Effort improved significantly: +${effortChange.toFixed(1)}`,
                            category: 'effort-improvement'
                        });
                    }
                    
                } else {
                    // Whanau leader logic
                    let severityScore = 0;
                    
                    const previousStudent = previousStudentsData.find(prev => prev.id === student.id);
                    const newPastoralEntries = previousStudent ? 
                        Math.max(0, (countAllPastoral - (previousStudent.countAllPastoral || 0))) : 0;
                    const hasSignificantPastoralIncrease = newPastoralEntries >= 3;
                    
                    if (hdp15Days < 50) severityScore += (50 - hdp15Days) * 2;
                    if (tCount15Days >= 6) severityScore += tCount15Days * 3;
                    if (unknownCount15Days >= 10) severityScore += unknownCount15Days;
                    if (hasSignificantPastoralIncrease) severityScore += newPastoralEntries * 2;
                    
                    const isEscalation = hdp15Days < 50 || tCount15Days >= 10 || hasSignificantPastoralIncrease;
                    
                    if (tCount15Days >= 8 || lCount15Days >= 20 || unknownCount15Days >= 15 || isEscalation) {
                        const reasons = [];
                        if (tCount15Days >= 8) reasons.push(`${tCount15Days} truancy incidents (15 days)`);
                        if (lCount15Days >= 20) reasons.push(`${lCount15Days} lates (15 days)`);
                        if (unknownCount15Days >= 15) reasons.push(`${unknownCount15Days} unknown attendance codes (15 days)`);
                        if (hdp15Days < 50) reasons.push(`Very low HDP (15 days): ${hdp15Days.toFixed(1)}%`);
                        if (hasSignificantPastoralIncrease) reasons.push(`🚨 ${newPastoralEntries} NEW pastoral incidents since last upload`);
                        
                        const item = {
                            ...student,
                            reason: reasons.join(', '),
                            severityScore: severityScore,
                            isEscalation: isEscalation
                        };
                        
                        currentAnalysis.urgentCalls.push(item);
                    }
                    
                    if ((lCount15Days >= 15 && lCount15Days < 20) || 
                             (unknownCount15Days >= 10 && unknownCount15Days < 15) || 
                             (student.hdpYear < 75) ||
                             (tCount15Days >= 6 && tCount15Days < 8)) {
                        const reasons = [];
                        if (lCount15Days >= 15 && lCount15Days < 20) reasons.push(`${lCount15Days} lates (15 days)`);
                        if (unknownCount15Days >= 10 && unknownCount15Days < 15) reasons.push(`${unknownCount15Days} unknown codes (15 days)`);
                        if (student.hdpYear < 75) reasons.push(`ACES referral needed - HDP Year: ${student.hdpYear.toFixed(1)}%`);
                        if (tCount15Days >= 6 && tCount15Days < 8) reasons.push(`${tCount15Days} truancy incidents (15 days)`);
                        
                        currentAnalysis.followUps.push({
                            ...student,
                            reason: reasons.join(', '),
                            needsACES: student.hdpYear < 75
                        });
                    }
                    
                    if ((student.hdpYear || 0) >= 95) {
                        currentAnalysis.celebrations.push({
                            ...student,
                            reason: `Excellent overall attendance: ${student.hdpYear.toFixed(1)}% (year)`,
                            category: 'attendance-overall'
                        });
                    }
                    
                    const prevStudentForCelebration = previousStudentsData.find(prev => prev.id === student.id);
                    if (prevStudentForCelebration) {
                        const hdpIncrease = (student.hdp15Days || 0) - (prevStudentForCelebration.hdp15Days || 0);
                        if (hdpIncrease >= 10) {
                            currentAnalysis.celebrations.push({
                                ...student,
                                reason: `Attendance improved by ${hdpIncrease.toFixed(1)}% (15 days): ${student.hdp15Days.toFixed(1)}%`,
                                category: 'attendance-increase'
                            });
                        }
                        
                        // Credit tracking for whanau leaders too
                        if ((student.yearLevel || 0) >= 11) {
                            const previousCredits = prevStudentForCelebration.cyTotalCredits || 0;
                            const currentCredits = student.cyTotalCredits || 0;
                            
                            if (currentCredits >= 80 && previousCredits < 80) {
                                currentAnalysis.celebrations.push({
                                    ...student,
                                    reason: `🎓 Newly passed Year ${student.yearLevel}! (${previousCredits} → ${currentCredits} credits)`,
                                    category: 'ncea-passed'
                                });
                            }
                        }
                    }
                    
                    if (effortChange >= 0.3) {
                        currentAnalysis.celebrations.push({
                            ...student,
                            reason: `Effort improved significantly: +${effortChange.toFixed(1)}`,
                            category: 'effort-improvement'
                        });
                    }
                }
            });

            if (currentUser.type === 'whanau-leader') {
                currentAnalysis.urgentCalls.sort((a, b) => b.severityScore - a.severityScore);
                
                const escalationCandidates = currentAnalysis.urgentCalls.filter(item => item.isEscalation);
                currentAnalysis.escalations = escalationCandidates.slice(0, 2);
                
                const escalatedIds = new Set(currentAnalysis.escalations.map(item => item.id));
                currentAnalysis.urgentCalls = currentAnalysis.urgentCalls.filter(item => !escalatedIds.has(item.id));
            }
            
            if (currentUser.type === 'tutor') {
                currentAnalysis.escalations.sort((a, b) => b.severity - a.severity);
                currentAnalysis.escalations = currentAnalysis.escalations.slice(0, 2);
            }

            updateAllDashboardSections();
        }
        
        function generateAdminDashboard() {
            if (currentUser.type !== 'admin' || rawStudentsData.length === 0) {
                return;
            }
            
            // Only generate admin dashboard if we're currently on the dashboard tab and user is admin
            const currentTab = document.querySelector('.tab-content.active');
            if (!currentTab || currentTab.id !== 'content-dashboard') {
                return;
            }
            
            // Filter out excluded students for analysis
            const activeStudents = rawStudentsData.filter(student => {
                const tutor = (student.tutor || '').trim().toUpperCase();
                const excludedCodes = ['ALTED', 'EXCLUDED', 'NHS', 'SSTS', ''];
                return !excludedCodes.includes(tutor);
            });
            
            // Calculate school-wide statistics
            const stats = {
                totalStudents: rawStudentsData.length,
                activeStudents: activeStudents.length,
                excludedStudents: rawStudentsData.length - activeStudents.length,
                
                // Year level breakdown
                yearLevels: {
                    year9: activeStudents.filter(s => s.yearLevel === 9).length,
                    year10: activeStudents.filter(s => s.yearLevel === 10).length,
                    year11: activeStudents.filter(s => s.yearLevel === 11).length,
                    year12: activeStudents.filter(s => s.yearLevel === 12).length,
                    year13: activeStudents.filter(s => s.yearLevel === 13).length
                },
                
                // House breakdown - use normalized house names
                houses: {
                    hinau: activeStudents.filter(s => normalizeHouseName(s.house) === 'Hīnau').length,
                    kowhai: activeStudents.filter(s => normalizeHouseName(s.house) === 'Kowhai').length,
                    tawa: activeStudents.filter(s => normalizeHouseName(s.house) === 'Tawa').length,
                    miro: activeStudents.filter(s => normalizeHouseName(s.house) === 'Miro').length
                },
                
                // Critical issues
                criticalAttendance: activeStudents.filter(s => (s.hdp15Days || 0) < 50).length,
                severeTruancy: activeStudents.filter(s => (s.tCount15Days || 0) >= 8).length,
                acesNeeded: activeStudents.filter(s => (s.hdpYear || 0) < 75).length,
                highPastoral: activeStudents.filter(s => (s.countAllPastoral || 0) >= 5).length,
                unknownCodes: activeStudents.reduce((sum, s) => sum + (s.unknownCount15Days || 0), 0),
                
                // Academic overview
                seniorStudents: activeStudents.filter(s => (s.yearLevel || 0) >= 11).length,
                passingNCEA: activeStudents.filter(s => (s.yearLevel || 0) >= 11 && (s.cyTotalCredits || 0) >= 60).length,
                strugglingAcademically: activeStudents.filter(s => (s.yearLevel || 0) >= 11 && (s.cyTotalCredits || 0) < 40).length,
                
                // Attendance averages
                averageHDP15Days: activeStudents.reduce((sum, s) => sum + (s.hdp15Days || 0), 0) / activeStudents.length,
                averageHDPYear: activeStudents.reduce((sum, s) => sum + (s.hdpYear || 0), 0) / activeStudents.length
            };
            
            // Analyze whānau classes for workload distribution
            const tutorGroups = {};
            activeStudents.forEach(student => {
                const tutorClass = student.tutor || 'Unknown';
                if (!tutorGroups[tutorClass]) {
                    tutorGroups[tutorClass] = {
                        students: [],
                        unknownCodes: 0,
                        urgentCases: 0,
                        house: normalizeHouseName(student.house) || 'Unknown'
                    };
                }
                tutorGroups[tutorClass].students.push(student);
                tutorGroups[tutorClass].unknownCodes += (student.unknownCount15Days || 0);
                
                // Count urgent cases (tutor logic)
                if ((student.unknownCount5Days || 0) >= 1 || 
                    (student.tCount5Days || 0) >= 1 || 
                    (student.lCount5Days || 0) >= 3) {
                    tutorGroups[tutorClass].urgentCases++;
                }
            });
            
            // House workload analysis - use normalized house names
            const houseWorkload = {
                'Hīnau': { urgentCases: 0, acesNeeded: 0, totalStudents: 0 },
                'Kowhai': { urgentCases: 0, acesNeeded: 0, totalStudents: 0 },
                'Tawa': { urgentCases: 0, acesNeeded: 0, totalStudents: 0 },
                'Miro': { urgentCases: 0, acesNeeded: 0, totalStudents: 0 }
            };
            
            activeStudents.forEach(student => {
                const house = normalizeHouseName(student.house);
                if (houseWorkload[house]) {
                    houseWorkload[house].totalStudents++;
                    
                    // Count urgent cases for whānau leaders
                    if ((student.tCount15Days || 0) >= 8 || 
                        (student.lCount15Days || 0) >= 20 || 
                        (student.unknownCount15Days || 0) >= 15 || 
                        (student.hdp15Days || 0) < 50) {
                        houseWorkload[house].urgentCases++;
                    }
                    
                    if ((student.hdpYear || 0) < 75) {
                        houseWorkload[house].acesNeeded++;
                    }
                }
            });
            
            updateAdminDashboardDisplay(stats, tutorGroups, houseWorkload);
        }
        
        function updateAdminDashboardDisplay(stats, tutorGroups, houseWorkload) {
            // Update the dashboard header for admin
            const dashboardCards = document.getElementById('dashboard-cards');
            if (!dashboardCards) return;
            
            dashboardCards.style.display = 'grid';
            dashboardCards.innerHTML = `
                <!-- School Overview Stats -->
                <div>
                    <div class="column-header" style="color: #667eea;">
                        📊 School Overview
                    </div>
                    
                    <div class="action-card">
                        <div class="card-header info">
                            <h4>👥 Student Population</h4>
                            <p>Total enrollment and breakdown</p>
                        </div>
                        <div class="card-content" style="text-align: left; padding: 1.5rem;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                <div>
                                    <strong>Total Students:</strong> ${stats.totalStudents}<br>
                                    <strong>Active Students:</strong> ${stats.activeStudents}<br>
                                    <strong>Excluded/Other:</strong> ${stats.excludedStudents}
                                </div>
                                <div>
                                    <strong>Average HDP (15 days):</strong> ${stats.averageHDP15Days.toFixed(1)}%<br>
                                    <strong>Average HDP (Year):</strong> ${stats.averageHDPYear.toFixed(1)}%<br>
                                    <strong>Unknown codes total:</strong> ${stats.unknownCodes}
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <strong>Year Levels:</strong><br>
                                Year 9: ${stats.yearLevels.year9} | Year 10: ${stats.yearLevels.year10} | Year 11: ${stats.yearLevels.year11} | Year 12: ${stats.yearLevels.year12} | Year 13: ${stats.yearLevels.year13}
                            </div>
                            
                            <div>
                                <strong>Houses:</strong><br>
                                Hīnau: ${stats.houses.hinau} | Kowhai: ${stats.houses.kowhai} | Tawa: ${stats.houses.tawa} | Miro: ${stats.houses.miro}
                            </div>
                        </div>
                    </div>
                    
                    <div class="action-card">
                        <div class="card-header success">
                            <h4>🎓 Academic Achievement</h4>
                            <p>NCEA progress for senior students</p>
                        </div>
                        <div class="card-content" style="text-align: left; padding: 1.5rem;">
                            <strong>Senior Students (Years 11-13):</strong> ${stats.seniorStudents}<br>
                            <strong>Passing NCEA (60+ credits):</strong> ${stats.passingNCEA} (${stats.seniorStudents > 0 ? ((stats.passingNCEA / stats.seniorStudents) * 100).toFixed(1) : '0'}%)<br>
                            <strong>Struggling academically (&lt;40 credits):</strong> ${stats.strugglingAcademically} (${stats.seniorStudents > 0 ? ((stats.strugglingAcademically / stats.seniorStudents) * 100).toFixed(1) : '0'}%)
                        </div>
                    </div>
                </div>
                
                <!-- Critical Issues -->
                <div>
                    <div class="column-header urgent-header">
                        🚨 Critical Issues & Workload
                    </div>
                    
                    <div class="action-card">
                        <div class="card-header urgent">
                            <h4>⚠️ Students Needing Immediate Attention</h4>
                            <p>High-priority cases across the school</p>
                        </div>
                        <div class="card-content" style="text-align: left; padding: 1.5rem;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div>
                                    <strong style="color: #dc2626;">Critical Attendance (&lt;50% HDP):</strong> ${stats.criticalAttendance}<br>
                                    <strong style="color: #ea580c;">Severe Truancy (8+ T codes):</strong> ${stats.severeTruancy}<br>
                                    <strong style="color: #d97706;">ACES Referrals Needed (&lt;75% HDP Year):</strong> ${stats.acesNeeded}
                                </div>
                                <div>
                                    <strong style="color: #7c2d12;">High Pastoral Incidents (5+):</strong> ${stats.highPastoral}<br>
                                    <strong style="color: #166534;">Students at academic risk:</strong> ${stats.strugglingAcademically}<br>
                                    <strong style="color: #1e40af;">Total unknown codes to resolve:</strong> ${stats.unknownCodes}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="action-card">
                        <div class="card-header warning">
                            <h4>🏠 House Workload Distribution</h4>
                            <p>Urgent cases by whānau leader</p>
                        </div>
                        <div class="card-content" style="text-align: left; padding: 1.5rem;">
                            ${Object.entries(houseWorkload).map(([house, data]) => {
                                const urgentPercentage = data.totalStudents > 0 ? ((data.urgentCases / data.totalStudents) * 100).toFixed(1) : '0';
                                const acesPercentage = data.totalStudents > 0 ? ((data.acesNeeded / data.totalStudents) * 100).toFixed(1) : '0';
                                return `
                                    <div style="margin-bottom: 0.75rem; padding: 0.75rem; background: #f8fafc; border-radius: 8px; border-left: 4px solid #667eea;">
                                        <strong>${house}:</strong> ${data.totalStudents} students<br>
                                        <span style="font-size: 0.875rem;">
                                            Urgent cases: ${data.urgentCases} (${urgentPercentage}%) | ACES needed: ${data.acesNeeded} (${acesPercentage}%)
                                        </span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    
                    <div class="action-card">
                        <div class="card-header info">
                            <h4>👨‍🏫 Whānau Teacher Support Needed</h4>
                            <p>Classes with highest unknown code counts</p>
                        </div>
                        <div class="card-content" style="text-align: left; padding: 1.5rem;">
                            ${Object.entries(tutorGroups)
                                .filter(([tutorClass]) => tutorClass !== 'Unknown')
                                .sort((a, b) => b[1].unknownCodes - a[1].unknownCodes)
                                .slice(0, 8)
                                .map(([tutorClass, data]) => {
                                    const avgUnknown = data.students.length > 0 ? (data.unknownCodes / data.students.length).toFixed(1) : '0';
                                    const priorityLevel = data.unknownCodes >= 20 ? 'urgent' : data.unknownCodes >= 10 ? 'warning' : 'success';
                                    const priorityColor = priorityLevel === 'urgent' ? '#dc2626' : priorityLevel === 'warning' ? '#ea580c' : '#16a34a';
                                    return `
                                        <div style="margin-bottom: 0.5rem; padding: 0.5rem; background: #f8fafc; border-radius: 6px; border-left: 3px solid ${priorityColor};">
                                            <strong>${tutorClass}</strong> (${data.house}): ${data.unknownCodes} ? codes | ${data.urgentCases} urgent cases | ${avgUnknown} avg ? codes per student
                                        </div>
                                    `;
                                }).join('')}
                        </div>
                    </div>
                </div>
            `;
            
            // Update the main dashboard stats for admin
            const elements = {
                'urgent-calls-stat': stats.criticalAttendance + stats.severeTruancy,
                'follow-ups-stat': stats.acesNeeded,
                'celebrations-stat': stats.passingNCEA,
                'total-actions': stats.criticalAttendance + stats.severeTruancy + stats.acesNeeded
            };
            
            Object.entries(elements).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) element.textContent = value;
            });
            
            // Update stat labels for admin
            const urgentLabel = document.getElementById('urgent-calls-label');
            if (urgentLabel) urgentLabel.textContent = 'Critical Cases';
            
            const followLabel = document.querySelector('#stats-row .stat-box:nth-child(2) .stat-label');
            if (followLabel) followLabel.textContent = 'ACES Needed';
            
            const celebrationLabel = document.querySelector('#stats-row .stat-box:nth-child(3) .stat-label');
            if (celebrationLabel) celebrationLabel.textContent = 'Passing NCEA';
        }

        function isStudentInCooldown(category, studentId) {
            const completedAction = completedActions[category]?.get(studentId);
            if (!completedAction) return false;
            
            const daysSinceCompletion = (new Date() - completedAction.completedDate) / (1000 * 60 * 60 * 24);
            return daysSinceCompletion < completedAction.cooldownDays;
        }

        function updateAllDashboardSections() {
            if (currentUser && currentUser.type === 'admin') {
                return;
            }
            
            updateDashboardStats();
            updateSectionContent();
        }

        function updateDashboardStats() {
            if (currentUser && currentUser.type === 'admin') {
                return; // Admin stats are handled by generateAdminDashboard
            }
            
            const elements = {
                'urgent-calls-stat': currentAnalysis.urgentCalls.length,
                'follow-ups-stat': currentAnalysis.followUps.length,
                'celebrations-stat': currentAnalysis.celebrations.length,
                'total-actions': currentAnalysis.urgentCalls.length + currentAnalysis.followUps.length
            };
            
            Object.entries(elements).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) element.textContent = value;
            });
        }

        function updateSectionContent() {
            updateSection('urgent-calls-content', currentAnalysis.urgentCalls, 'No urgent follow-ups needed today! 🎉');
            updateSection('escalation-content', currentAnalysis.escalations, 'No escalations to leadership needed! 🎉');
            updateSection('followup-content', currentAnalysis.followUps, 'No medium priority follow-ups needed today!');
            updateSection('celebration-content', currentAnalysis.celebrations, 'No celebrations identified today');
            updateSection('urgent-tab-content', currentAnalysis.urgentCalls, 'No urgent actions needed today! 🎉');
            
            updateCelebrationCards();
            updateTutorAnalysis();
        }

        function updateCelebrationCards() {
            const attendanceOverall = currentAnalysis.celebrations.filter(c => c.category === 'attendance-overall');
            const attendanceIncrease = currentAnalysis.celebrations.filter(c => c.category === 'attendance-increase');
            const nceaPassed = currentAnalysis.celebrations.filter(c => c.category === 'ncea-passed');
            const yearPassed = currentAnalysis.celebrations.filter(c => c.category === 'year-passed');
            const effortImprovement = currentAnalysis.celebrations.filter(c => c.category === 'effort-improvement');
            
            updateSection('celebrations-attendance-overall-content', attendanceOverall, 'No students with 95%+ overall attendance');
            updateSection('celebrations-attendance-increase-content', attendanceIncrease, 'No significant attendance improvements this period');
            updateSection('celebrations-ncea-passed-content', nceaPassed.concat(yearPassed), 'No newly passed NCEA students this upload');
            updateSection('celebrations-effort-improvement-content', effortImprovement, 'No significant effort improvements detected');
        }

        function updateTutorAnalysis() {
            if (currentUser.type !== 'whanau-leader' || filteredStudentsData.length === 0) {
                return;
            }

            // Group students by tutor class
            const tutorGroups = {};
            filteredStudentsData.forEach(student => {
                const tutorClass = student.tutor || 'Unknown';
                if (!tutorGroups[tutorClass]) {
                    tutorGroups[tutorClass] = [];
                }
                tutorGroups[tutorClass].push(student);
            });

            // Calculate overall average ? codes per student across all classes in the house
            const allStudents = filteredStudentsData;
            const totalUnknownCodes = allStudents.reduce((sum, s) => sum + (s.unknownCount15Days || 0), 0);
            const houseAverageUnknownCodes = totalUnknownCodes / allStudents.length;

            // Analyze each tutor group focusing on ? codes
            const tutorAnalysis = [];
            Object.entries(tutorGroups).forEach(([tutorClass, students]) => {
                if (tutorClass === 'Unknown' || students.length === 0) return;

                const totalStudents = students.length;
                const totalUnknownCodesInClass = students.reduce((sum, s) => sum + (s.unknownCount15Days || 0), 0);
                const averageUnknownCodes = totalUnknownCodesInClass / totalStudents;
                
                // Count students with concerning ? code levels
                const studentsWithHighUnknownCodes = students.filter(s => (s.unknownCount15Days || 0) >= 5).length;
                const studentsWithVeryHighUnknownCodes = students.filter(s => (s.unknownCount15Days || 0) >= 10).length;
                
                // Determine if class needs support (above house average)
                const aboveAverage = averageUnknownCodes > houseAverageUnknownCodes;
                const significantlyAboveAverage = averageUnknownCodes > (houseAverageUnknownCodes * 1.5);

                // Additional context metrics
                const avgAttendance = students.reduce((sum, s) => sum + (s.hdp15Days || 0), 0) / totalStudents;

                tutorAnalysis.push({
                    tutorClass,
                    totalStudents,
                    averageUnknownCodes: averageUnknownCodes.toFixed(1),
                    studentsWithHighUnknownCodes,
                    studentsWithVeryHighUnknownCodes,
                    avgAttendance: avgAttendance.toFixed(1),
                    aboveAverage,
                    significantlyAboveAverage,
                    differenceFromAverage: (averageUnknownCodes - houseAverageUnknownCodes).toFixed(1)
                });
            });

            // Sort by average unknown codes (highest first)
            tutorAnalysis.sort((a, b) => parseFloat(b.averageUnknownCodes) - parseFloat(a.averageUnknownCodes));

            // Update the tutor analysis content
            const tutorAnalysisElement = document.getElementById('tutor-analysis-content');
            if (tutorAnalysisElement) {
                if (tutorAnalysis.length === 0) {
                    tutorAnalysisElement.innerHTML = '<div class="card-content success-message">No whānau classes to analyze! 🎉</div>';
                    return;
                }

                let html = '<div style="padding: 1rem;">';
                
                // House overview
                html += `
                    <div style="margin-bottom: 1.5rem; padding: 1rem; background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 8px;">
                        <strong>📊 ${currentUser.house} House Overview:</strong><br>
                        <span style="font-size: 0.875rem;">
                            House average ? codes per student (15 days): <strong>${houseAverageUnknownCodes.toFixed(1)}</strong><br>
                            Total students: <strong>${allStudents.length}</strong>
                        </span>
                    </div>
                `;

                // Classes needing support (above average)
                const classesNeedingSupport = tutorAnalysis.filter(a => a.aboveAverage);
                const classesPerformingWell = tutorAnalysis.filter(a => !a.aboveAverage);

                if (classesNeedingSupport.length > 0) {
                    html += `<div style="margin-bottom: 1.5rem;"><h4 style="color: #dc2626; margin-bottom: 1rem;">⚠️ Classes Needing Follow-up Support</h4>`;
                    
                    classesNeedingSupport.forEach(analysis => {
                        const supportLevel = analysis.significantlyAboveAverage ? 'urgent' : 'warning';
                        const supportIcon = analysis.significantlyAboveAverage ? '🚨' : '⚠️';
                        
                        html += `
                            <div class="student-item student-${supportLevel}" style="margin-bottom: 1rem;">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                    <div style="flex: 1;">
                                        <strong style="font-size: 1rem;">${analysis.tutorClass}</strong>
                                        <span style="margin-left: 0.5rem; font-size: 0.875rem; opacity: 0.8;">(${analysis.totalStudents} students)</span>
                                        <br>
                                        <span style="font-size: 0.875rem;">Average ? codes per student: <strong>${analysis.averageUnknownCodes}</strong> (+${analysis.differenceFromAverage} above house average)</span>
                                        <br>
                                        <span style="font-size: 0.875rem;">${analysis.studentsWithVeryHighUnknownCodes} students with 10+ ? codes, ${analysis.studentsWithHighUnknownCodes} with 5+ ? codes</span>
                                        <br>
                                        <span style="font-size: 0.875rem; opacity: 0.8;">Class attendance average: ${analysis.avgAttendance}%</span>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-weight: 600; font-size: 0.875rem;">${supportIcon} Follow-up Support Needed</div>
                                        <div style="font-size: 0.75rem; opacity: 0.7;">${analysis.significantlyAboveAverage ? 'Urgent' : 'Moderate'} Priority</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                }

                if (classesPerformingWell.length > 0) {
                    html += `<div style="margin-bottom: 1rem;"><h4 style="color: #16a34a; margin-bottom: 1rem;">✅ Classes Performing Well</h4>`;
                    
                    classesPerformingWell.forEach(analysis => {
                        html += `
                            <div class="student-item student-success" style="margin-bottom: 0.75rem;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <strong style="font-size: 1rem;">${analysis.tutorClass}</strong>
                                        <span style="margin-left: 0.5rem; font-size: 0.875rem; opacity: 0.8;">(${analysis.totalStudents} students)</span>
                                        <br>
                                        <span style="font-size: 0.875rem;">Average ? codes: <strong>${analysis.averageUnknownCodes}</strong> (${analysis.differenceFromAverage} below house average)</span>
                                    </div>
                                    <div style="font-size: 0.875rem; color: #16a34a; font-weight: 600;">
                                        ✨ Good follow-up work
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                }

                html += `
                    <div style="margin-top: 1.5rem; padding: 1rem; background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 8px; font-size: 0.875rem;">
                        <strong>📋 Action Required:</strong><br>
                        • <strong>? codes</strong> (unknown attendance) should be resolved daily by whānau teachers<br>
                        • Classes above house average may need support with attendance follow-up procedures<br>
                        • Consider offering training or mentoring for classes consistently above average<br>
                        • Recognize and learn from classes performing well below average
                    </div>
                `;

                html += '</div>';
                tutorAnalysisElement.innerHTML = html;
            }
        }

        function updateSection(elementId, items, emptyMessage) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            const categoryMap = {
                'urgent-calls-content': 'urgentCalls',
                'escalation-content': 'escalations', 
                'followup-content': 'followUps',
                'celebration-content': 'celebrations',
                'urgent-tab-content': 'urgentCalls',
                'celebrations-attendance-overall-content': 'celebrations',
                'celebrations-attendance-increase-content': 'celebrations',
                'celebrations-ncea-passed-content': 'celebrations',
                'celebrations-effort-improvement-content': 'celebrations'
            };
            
            const category = categoryMap[elementId];
            
            let activeItems = items;
            if (category && completedActions[category]) {
                // Special handling for tutors: always show attendance urgent items
                if (currentUser?.type === 'tutor' && elementId === 'urgent-calls-content') {
                    // For tutors, show attendance urgent items always, but filter pastoral/academic items by cooldown
                    activeItems = items.filter(item => {
                        if (item.isAttendanceUrgent) {
                            return true; // Always show T codes, ? codes, lates for tutors
                        }
                        return !isStudentInCooldown(category, item.id); // Apply cooldown to pastoral/academic
                    });
                } else {
                    // For all other cases, apply normal cooldown filtering
                    activeItems = items.filter(item => !isStudentInCooldown(category, item.id));
                }
            }
            
            if (activeItems.length === 0) {
                element.innerHTML = `<div class="card-content success-message">${emptyMessage}</div>`;
                return;
            }

            let html = '<div style="padding: 1rem;">';
            const displayItems = activeItems.slice(0, 5);
            
            displayItems.forEach(student => {
                const tutorDisplay = currentUser && currentUser.type === 'whanau-leader' ? ` (${student.tutor})` : '';
                
                let actionButtons = '';
                
                if (student.needsACES && currentUser && currentUser.type === 'whanau-leader') {
                    actionButtons += `<button onclick="generateACESEmail('${student.id}')" 
                                             class="btn btn-primary btn-sm" style="margin-right: 0.5rem;">
                                        📧 ACES Email
                                      </button>`;
                }
                
                actionButtons += `<button onclick="completeAction('${elementId}', '${student.id}')" 
                                         class="btn btn-success btn-sm">
                                    ✓ Complete
                                  </button>
                                  <button onclick="showCooldownOptions('${elementId}', '${student.id}')" 
                                         class="btn btn-warning btn-sm" style="margin-left: 0.25rem;">
                                    ⏰ Custom
                                  </button>`;
                
                html += `<div class="student-item" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;" id="item-${elementId}-${student.id}">
                            <div>
                                <strong><span onclick="showStudentOverview('${student.id}')" style="cursor: pointer; text-decoration: underline; color: #667eea;">${student.id}</span></strong>${tutorDisplay}<br>
                                ${student.reason}
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                ${actionButtons}
                            </div>
                         </div>`;
            });
            
            if (activeItems.length > 5) {
                html += `<div style="text-align: center; padding: 0.5rem; color: #ea580c; font-weight: 600;">
                            +${activeItems.length - 5} more waiting
                         </div>`;
            }
            
            html += '</div>';
            element.innerHTML = html;
        }

        function showNoDataMessage(userType) {
            const message = userType === 'admin' ? 
                'Upload CSV data to get started' : 
                '⚠️ No data available. Please ask the Data Administrator to upload the CSV file first.';
            
            if (userType === 'tutor') {
                const contentIds = ['urgent-calls-content', 'escalation-content', 'followup-content', 'celebration-content'];
                contentIds.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.innerHTML = `<div class="card-content" style="color: #ea580c;">${message}</div>`;
                    }
                });

                // Also update tutor analysis for whanau leaders
                const tutorAnalysisElement = document.getElementById('tutor-analysis-content');
                if (tutorAnalysisElement) {
                    tutorAnalysisElement.innerHTML = `<div class="card-content" style="color: #ea580c;">${message}</div>`;
                }
            } else if (userType === 'whanau-leader') {
                const contentIds = [
                    'urgent-calls-content', 'escalation-content', 'followup-content', 
                    'celebration-content', 'urgent-tab-content'
                ];
                
                contentIds.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.innerHTML = `<div class="card-content" style="color: #ea580c;">${message}</div>`;
                    }
                });
            }
        }

        function resetAllContent() {
            const defaultMessage = '📁 Upload student data to see information';
            const contentIds = [
                'urgent-calls-content', 'escalation-content', 'followup-content', 
                'celebration-content', 'urgent-tab-content'
            ];
            
            contentIds.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.innerHTML = `<div class="card-content">${defaultMessage}</div>`;
                }
            });

            // Also reset tutor analysis
            const tutorAnalysisElement = document.getElementById('tutor-analysis-content');
            if (tutorAnalysisElement) {
                tutorAnalysisElement.innerHTML = `<div class="card-content">${defaultMessage}</div>`;
            }
            
            const statIds = ['urgent-calls-stat', 'follow-ups-stat', 'celebrations-stat', 'total-actions'];
            statIds.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.textContent = '0';
            });
        }

        function completeAction(category, studentId, customCooldownDays = null) {
            const categoryMap = {
                'urgent-calls-content': 'urgentCalls',
                'escalation-content': 'escalations',
                'followup-content': 'followUps', 
                'celebration-content': 'celebrations',
                'urgent-tab-content': 'urgentCalls'
            };
            
            // Default cooldown periods by category
            const defaultCooldowns = {
                'urgentCalls': 3,     // 3 days for urgent calls
                'escalations': 5,     // 5 days for escalations  
                'followUps': 7,       // 1 week for follow-ups
                'celebrations': 14    // 2 weeks for celebrations
            };
            
            const actionCategory = categoryMap[category];
            if (actionCategory) {
                const cooldownDays = customCooldownDays || defaultCooldowns[actionCategory];
                
                completedActions[actionCategory].set(studentId, {
                    completedDate: new Date(),
                    cooldownDays: cooldownDays,
                    completedBy: currentUser?.role || 'Unknown'
                });
                
                // Set pastoral baseline when completing pastoral-related actions
                const student = filteredStudentsData.find(s => s.id === studentId);
                if (student && (actionCategory === 'urgentCalls' || actionCategory === 'escalations')) {
                    // Store current pastoral counts as baseline
                    completedActions.pastoralBaseline.set(studentId, {
                        pastoralA: student.pastoralA || 0,
                        pastoralC: student.pastoralC || 0,
                        pastoralD: student.pastoralD || 0,
                        pastoralU: student.pastoralU || 0,
                        baselineDate: new Date()
                    });
                }
                
                const itemElement = document.getElementById(`item-${category}-${studentId}`);
                if (itemElement) {
                    itemElement.style.transition = 'opacity 0.3s ease-out, transform 0.3s ease-out';
                    itemElement.style.opacity = '0';
                    itemElement.style.transform = 'translateX(100%)';
                    
                    setTimeout(() => {
                        updateAllDashboardSections();
                        updateDashboardStats();
                    }, 300);
                }
                
                showToast(`✅ Completed action for ${studentId} (hidden until new changes)`);
            }
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                if (document.body.contains(toast)) {
                    document.body.removeChild(toast);
                }
            }, 3000);
        }

        function generateACESEmail(studentId) {
            const student = filteredStudentsData.find(s => s.id === studentId);
            if (!student) {
                alert('Student data not found');
                return;
            }

            const emailTemplate = `Subject: ACES Referral - ${student.id} - Attendance Concerns

Kia ora,

I am referring ${student.id} from ${student.tutor} whānau for attendance support.

CURRENT ATTENDANCE DATA:
• Overall Attendance Year: ${(student.inClassYear || 0).toFixed(1)}%
• Half Day Percentage Year: ${(student.hdpYear || 0).toFixed(1)}%
• Half Day Percentage (15 days): ${(student.hdp15Days || 0).toFixed(1)}%
• Truancy incidents (15 days): ${student.tCount15Days || 0}
• Late arrivals (15 days): ${student.lCount15Days || 0}
• Unknown attendance codes (15 days): ${student.unknownCount15Days || 0}

PASTORAL CONCERNS:
• Total pastoral incidents: ${student.countAllPastoral || 0}
• Classroom: ${student.pastoralC || 0} | Discipline: ${student.pastoralD || 0} | Uniform: ${student.pastoralU || 0}

This student requires ACES support due to yearly HDP below 75% (${(student.hdpYear || 0).toFixed(1)}%).

Please arrange appropriate support for this student.

Ngā mihi,
${currentUser.role}`;

            showEmailModal(emailTemplate);
        }

        function showEmailModal(emailText) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'email-modal';
            
            const modalContent = document.createElement('div');
            modalContent.className = 'modal-content';
            
            modalContent.innerHTML = `
                <h3 style="margin-bottom: 1rem; color: #1f2937;">📧 ACES Referral Email</h3>
                <textarea readonly style="width: 100%; height: 400px; padding: 1rem; border: 1px solid #e5e7eb; border-radius: 12px; font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace; font-size: 0.875rem; resize: vertical;">${emailText}</textarea>
                <div style="margin-top: 1.5rem; text-align: center; display: flex; gap: 1rem; justify-content: center;">
                    <button onclick="copyEmailText()" class="btn btn-primary">
                        📋 Copy Email
                    </button>
                    <button onclick="closeEmailModal()" class="btn" style="background: #6b7280; color: white;">
                        Close
                    </button>
                </div>
            `;
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
        }

        function copyEmailText() {
            const textarea = document.querySelector('#email-modal textarea');
            if (textarea) {
                textarea.select();
                document.execCommand('copy');
                showToast('📧 Email copied to clipboard!');
            }
        }

        function closeEmailModal() {
            const modal = document.getElementById('email-modal');
            if (modal) {
                document.body.removeChild(modal);
            }
        }

        function showStudentOverview(studentId) {
            const student = filteredStudentsData.find(s => s.id === studentId);
            if (!student) {
                alert('Student data not found');
                return;
            }

            const effortChange = (student.classEffort15Days || 0) - (student.classEffortYear || 0);
            const effortDirection = effortChange >= 0 ? '↗️' : '↘️';
            
            const concerns = [];
            if ((student.tCount15Days || 0) >= 6) concerns.push(`🚨 HIGH TRUANCY: ${student.tCount15Days} incidents (15 days)`);
            if ((student.unknownCount15Days || 0) >= 10) concerns.push(`❓ HIGH UNKNOWN CODES: ${student.unknownCount15Days} (15 days)`);
            if ((student.lCount15Days || 0) >= 15) concerns.push(`⏰ EXCESSIVE LATES: ${student.lCount15Days} (15 days)`);
            if ((student.unknownCount15Days || 0) >= 6 && (student.unknownCount15Days || 0) < 10) concerns.push(`❓ Unknown codes: ${student.unknownCount15Days} (15 days)`);
            if ((student.lCount15Days || 0) >= 10 && (student.lCount15Days || 0) < 15) concerns.push(`⏰ Regular lates: ${student.lCount15Days} (15 days)`);
            if ((student.hdp15Days || 0) < 50) concerns.push(`🔴 CRITICAL HDP (15 days): ${student.hdp15Days.toFixed(1)}%`);
            if ((student.hdp15Days || 0) >= 50 && (student.hdp15Days || 0) < 75) concerns.push(`🟡 Low HDP (15 days): ${student.hdp15Days.toFixed(1)}%`);
            if ((student.countAllPastoral || 0) >= 3) concerns.push(`📋 ${student.countAllPastoral} pastoral incidents`);
            
            if ((student.yearLevel || 0) >= 11) {
                if ((student.cyPercentPassed || 0) < 50) concerns.push(`📚 LOW PASS RATE: ${student.cyPercentPassed.toFixed(0)}%`);
                if ((student.cyTotalCredits || 0) < 40 && (student.yearLevel || 0) >= 12) concerns.push(`📚 LOW CREDITS: ${student.cyTotalCredits} credits`);
            }
            
            const positives = [];
            if ((student.hdpYear || 0) >= 95) positives.push(`✨ Excellent attendance (year): ${student.hdpYear.toFixed(1)}%`);
            if ((student.hdp15Days || 0) >= 95) positives.push(`✨ Excellent recent attendance (15 days): ${student.hdp15Days.toFixed(1)}%`);
            if (effortChange >= 0.3) positives.push(`📈 Effort improving: +${effortChange.toFixed(1)}`);
            if ((student.hdpYear || 0) >= 85 && (student.hdpYear || 0) < 95) positives.push(`✅ Good attendance (year): ${student.hdpYear.toFixed(1)}%`);
            if ((student.hdp15Days || 0) >= 85 && (student.hdp15Days || 0) < 95) positives.push(`✅ Good recent attendance (15 days): ${student.hdp15Days.toFixed(1)}%`);
            if ((student.yearLevel || 0) >= 11 && (student.cyTotalCredits || 0) >= 80) positives.push(`🎓 Passed Year ${student.yearLevel} (${student.cyTotalCredits} credits)`);
            if ((student.yearLevel || 0) >= 11 && (student.cyPercentPassed || 0) >= 90) positives.push(`📚 Excellent pass rate: ${student.cyPercentPassed.toFixed(0)}%`);
            
            const overview = `
📊 STUDENT OVERVIEW: ${student.id}
${currentUser.type === 'whanau-leader' ? `🏠 Whānau Class: ${student.tutor}` : ''}
${currentUser.type === 'whanau-leader' ? `🌺 House: ${student.house}` : ''}
👤 Year ${student.yearLevel || 'N/A'} ${student.gender || 'N/A'} (${student.ethnicity || 'N/A'})

📈 ATTENDANCE DATA:
• Half Day Percentage (15 days): ${(student.hdp15Days || 0).toFixed(1)}%
• Half Day Percentage (5 days): ${(student.hdp5Days || 0).toFixed(1)}%
• Half Day Percentage (year): ${(student.hdpYear || 0).toFixed(1)}%
• In Class Percentage (15 days): ${(student.inClass15Days || 0).toFixed(1)}%
• Trend: ${student.hdpTrend || 'No trend data'}
• Late incidents (15 days): ${student.lCount15Days || 0}
• Unknown codes (15 days): ${student.unknownCount15Days || 0}
• Truancy incidents (15 days): ${student.tCount15Days || 0}

📚 EFFORT & ACADEMIC DATA:
• Year effort average: ${(student.classEffortYear || 0).toFixed(1)}
• Recent effort (15 days): ${(student.classEffort15Days || 0).toFixed(1)} ${effortDirection}
• Change: ${effortChange >= 0 ? '+' : ''}${effortChange.toFixed(1)}${(student.yearLevel || 0) >= 11 ? `
• Current Year Credits: ${student.cyTotalCredits || 0}
• Credits Breakdown: ${student.cyExcellence || 0} Excellence, ${student.cyMerit || 0} Merit, ${student.cyAchieved || 0} Achieved, ${student.cyNotAchieved || 0} Not Achieved
• Pass Rate: ${(student.cyPercentPassed || 0).toFixed(1)}%` : ''}

📋 PASTORAL DATA:
• Total pastoral incidents: ${student.countAllPastoral || 0}
• Classroom: ${student.pastoralC || 0} | Discipline: ${student.pastoralD || 0} | Uniform: ${student.pastoralU || 0}
• Other: ${student.pastoralO || 0} | Attendance: ${student.pastoralA || 0} | Guidance: ${student.pastoralG || 0}

${concerns.length > 0 ? `⚠️ CONCERNS:\n${concerns.map(c => `• ${c}`).join('\n')}\n` : ''}
${positives.length > 0 ? `🌟 POSITIVES:\n${positives.map(p => `• ${p}`).join('\n')}\n` : ''}
${concerns.length === 0 && positives.length === 0 ? '✅ No major concerns - student performing adequately' : ''}
            `.trim();

            showStudentModal(overview, student);
        }

        function showStudentModal(overviewText, student) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'student-modal';
            
            const modalContent = document.createElement('div');
            modalContent.className = 'modal-content';
            
            let actionButtons = '';
            
            if ((student.hdpYear || 0) < 75 && currentUser.type === 'whanau-leader') {
                actionButtons += `
                    <button onclick="generateACESEmail('${student.id}'); closeStudentModal();" class="btn btn-primary">
                        📧 Generate ACES Email
                    </button>`;
            }
            
            if ((student.tCount15Days || 0) >= 6) {
                actionButtons += `
                    <button onclick="showToast('Urgent call logged for ${student.id}'); closeStudentModal();" class="btn btn-danger">
                        📞 Log Urgent Call
                    </button>`;
            }
            
            modalContent.innerHTML = `
                <h3 style="margin-bottom: 1rem; color: #1f2937;">📋 Student Overview</h3>
                <pre style="white-space: pre-wrap; font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; font-size: 0.875rem; line-height: 1.6; background: #f8fafc; padding: 1.5rem; border-radius: 12px; border: 1px solid #e5e7eb; max-height: 400px; overflow-y: auto;">${overviewText}</pre>
                <div style="margin-top: 1.5rem; text-align: center; display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                    ${actionButtons}
                    <button onclick="closeStudentModal()" class="btn" style="background: #6b7280; color: white;">
                        Close
                    </button>
                </div>
            `;
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
        }

        function showCooldownOptions(category, studentId) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'cooldown-modal';
            
            const modalContent = document.createElement('div');
            modalContent.className = 'modal-content';
            
            modalContent.innerHTML = `
                <h3 style="margin-bottom: 1rem; color: #1f2937;">⏰ Set Cooldown Period</h3>
                <p style="margin-bottom: 1.5rem; color: #6b7280;">How long should this action be hidden for <strong>${studentId}</strong>?</p>
                <div style="display: grid; gap: 0.75rem;">
                    <button onclick="completeAction('${category}', '${studentId}', 1); closeCooldownModal();" class="btn btn-primary">
                        1 Day - Quick follow-up
                    </button>
                    <button onclick="completeAction('${category}', '${studentId}', 3); closeCooldownModal();" class="btn btn-primary">
                        3 Days - Standard (Default)
                    </button>
                    <button onclick="completeAction('${category}', '${studentId}', 7); closeCooldownModal();" class="btn btn-primary">
                        1 Week - Longer intervention
                    </button>
                    <button onclick="completeAction('${category}', '${studentId}', 14); closeCooldownModal();" class="btn btn-primary">
                        2 Weeks - Major intervention
                    </button>
                    <button onclick="completeAction('${category}', '${studentId}', 30); closeCooldownModal();" class="btn btn-warning">
                        1 Month - Resolved issue
                    </button>
                </div>
                <div style="margin-top: 1.5rem; text-align: center;">
                    <button onclick="closeCooldownModal()" class="btn" style="background: #6b7280; color: white;">
                        Cancel
                    </button>
                </div>
            `;
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
        }

        function closeStudentModal() {
            const modal = document.getElementById('student-modal');
            if (modal) {
                document.body.removeChild(modal);
            }
        }

        function closeCooldownModal() {
            const modal = document.getElementById('cooldown-modal');
            if (modal) {
                document.body.removeChild(modal);
            }
        }
    </script>
</body>
</html>
